<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal Interno | Sono Show</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <style>
    .nav-link.active { border-bottom: 4px solid #3b82f6; color: #1e293b; font-weight: bold; }
    .card-zoom:hover { transform: translateY(-5px); transition: all 0.3s; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .animate-fadeIn { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #carousel-slides { transition: transform 0.5s ease-in-out; }

    .banner-container { height: 250px; }
    @media (min-width: 1024px) { .banner-container { height: 450px; } }
    
    /* Estilo para a miniatura do PDF */
    .pdf-thumb-canvas { width: 100%; height: 100%; object-fit: cover; }
    
    html.iframe-mode header { position: static !important; box-shadow: none !important; padding: 0.5rem; }
    html.iframe-mode .banner-container { height: 180px !important; }
  </style>

  <script>
    const isInIframe = window.self !== window.top;
    if (isInIframe) document.documentElement.classList.add("iframe-mode");
    
    // Configura o worker do PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center">
      <img src="https://sonoshowmoveis.vtexassets.com/assets/vtex.file-manager-graphql/images/9c25daff-344c-4bbf-9adf-054dba3b5137___c25ce75d1124b3ba71eebaaf2a2527e2.png" alt="Logo" class="h-10 mb-2 md:mb-0" />
      <nav class="flex space-x-4 md:space-x-6 text-gray-500 text-xs md:text-sm uppercase tracking-wider">
        <button onclick="switchTab('home')" class="nav-link active py-2 px-1 transition-all">Home</button>
        <button onclick="switchTab('treinamento')" class="nav-link py-2 px-1 transition-all">Treinamento</button>
        <button onclick="switchTab('rh')" class="nav-link py-2 px-1 transition-all">RH</button>
        <button onclick="switchTab('encartes')" class="nav-link py-2 px-1 transition-all">Encartes</button>
        <button onclick="switchTab('sobre')" class="nav-link py-2 px-1 transition-all">Sobre Sono Show</button>
        <button onclick="switchTab('faq')" class="nav-link py-2 px-1 transition-all">FAQ</button>
      </nav>
    </div>
  </header>

  <main id="tab-home" class="tab-content active container mx-auto p-4 animate-fadeIn">
    <div class="relative w-full bg-slate-900 rounded-2xl overflow-hidden shadow-xl border-4 border-white banner-container mb-8">
      <div id="carousel-slides" class="flex h-full w-full"></div>
      <button onclick="moveSlide(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/50 text-white w-10 h-10 rounded-full z-20 backdrop-blur-sm flex items-center justify-center">
        <i class="fas fa-chevron-left"></i>
      </button>
      <button onclick="moveSlide(1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/50 text-white w-10 h-10 rounded-full z-20 backdrop-blur-sm flex items-center justify-center">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <h3 class="text-xl font-bold text-slate-700 mb-6 flex items-center gap-2 italic">
      <i class="fas fa-bullhorn text-blue-500"></i> QUADRO DE AVISOS
    </h3>
    <div id="grid-comunicados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </main>

  <main id="tab-treinamento" class="tab-content container mx-auto p-4">
    <div class="bg-white rounded-2xl shadow-lg p-6 min-h-[500px]">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold text-slate-800 italic">ðŸ“‚ Manuais e Arquivos</h2>
        <input type="text" id="search" oninput="filterFiles()" placeholder="Buscar..." class="w-full md:w-64 bg-gray-100 rounded-lg py-2 px-4 outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div id="explorer-content" class="divide-y divide-gray-100"></div>
    </div>
  </main>

  <main id="tab-rh" class="tab-content container mx-auto p-4 text-center py-20">
    <div class="bg-white p-12 rounded-2xl shadow-lg max-w-2xl mx-auto border-b-8 border-blue-500">
      <i class="fas fa-user-tie text-6xl text-blue-100 mb-6"></i>
      <h2 class="text-3xl font-bold text-gray-700 text-center">EspaÃ§o do Colaborador</h2>
      <p class="text-gray-500 mt-4 italic">ConteÃºdos de RH em fase de implementaÃ§Ã£o.</p>
    </div>
  </main>

  <main id="tab-encartes" class="tab-content container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-8 italic flex items-center gap-3 text-slate-800">
      <span class="bg-blue-600 text-white p-2 rounded-lg shadow-md"><i class="fas fa-tags"></i></span>
      Encartes e PromoÃ§Ãµes Atuais
    </h2>
    <div id="grid-encartes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8"></div>
  </main>

  <script>
    const USER = "jeanmelosonoshow";
    const REPO = "Sono-Show";
    let currentSlide = 0, totalSlides = 0, allFiles = [];

    // FunÃ§Ã£o para gerar miniatura do PDF
    async function generatePdfThumb(url, canvasId) {
      try {
        const loadingTask = pdfjsLib.getDocument(url);
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 0.5 });
        const canvas = document.getElementById(canvasId);
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport: viewport }).promise;
      } catch (e) {
        console.error("Erro miniatura:", e);
      }
    }

    async function loadHomeData() {
      try {
        const response = await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/comunicados.json?t=${Date.now()}`);
        const data = await response.json();
        const carousel = document.getElementById("carousel-slides");
        if (data.banners) {
          totalSlides = data.banners.length;
          carousel.innerHTML = data.banners.map(img => `<div class="min-w-full h-full flex items-center justify-center bg-slate-900"><img src="${img}" class="max-w-full max-h-full object-contain"></div>`).join("");
        }
        document.getElementById("grid-comunicados").innerHTML = data.avisos.map(c => `
          <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-${c.cor}-500 card-zoom">
            <span class="text-[10px] font-bold text-${c.cor}-600 bg-${c.cor}-50 px-2 py-1 rounded uppercase">${c.categoria}</span>
            <h4 class="font-bold text-lg mt-3 text-slate-800 leading-tight">${c.titulo}</h4>
            <p class="text-gray-500 text-sm mt-2">${c.descricao}</p>
            <div class="mt-4 pt-4 border-t border-gray-50 text-[10px] text-gray-400 font-bold uppercase">${c.data}</div>
          </div>
        `).join("");
      } catch (e) { console.log(e); }
    }

   async function loadEncartes(path) {
  const container = document.getElementById("grid-encartes");
  container.innerHTML = '<p class="col-span-full text-center p-10 text-slate-400">Gerando visualizaÃ§Ãµes...</p>';
  
  try {
    const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`);
    const data = await res.json();
    
    // 1. Filtra apenas PDFs
    let pdfs = data.filter(i => i.name.toLowerCase().endsWith(".pdf"));

    // 2. OrdenaÃ§Ã£o Inteligente (Ano primeiro, depois MÃªs)
    pdfs.sort((a, b) => {
      // Extrai os primeiros 7 caracteres (ex: "02-2026")
      const partsA = a.name.substring(0, 7).split('-');
      const partsB = b.name.substring(0, 7).split('-');
      
      const mesA = partsA[0];
      const anoA = partsA[1];
      const mesB = partsB[0];
      const anoB = partsB[1];

      // Compara o Ano primeiro
      if (anoB !== anoA) {
        return anoB - anoA;
      }
      // Se o ano for igual, compara o MÃªs
      return mesB - mesA;
    });

    container.innerHTML = pdfs.map((pdf, index) => {
      const canvasId = `pdf-canvas-${index}`;
      const pdfUrl = `https://${USER}.github.io/${REPO}/${pdf.path}`;
      const isNew = index === 0; // O primeiro da lista ordenada Ã© o lanÃ§amento
      
      setTimeout(() => generatePdfThumb(pdfUrl, canvasId), 200);
      
      return `
        <div onclick="window.open('${pdfUrl}', '_blank')" class="relative cursor-pointer group bg-white rounded-xl shadow-md hover:shadow-2xl transition-all overflow-hidden border ${isNew ? 'border-amber-400 ring-2 ring-amber-100' : 'border-gray-100'} flex flex-col">
          
          ${isNew ? `
            <div class="absolute top-2 right-2 z-10 bg-amber-500 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1 animate-bounce">
              <i class="fas fa-star"></i> NOVO
            </div>
          ` : ''}

          <div class="aspect-[3/4] bg-gray-200 relative overflow-hidden flex items-center justify-center">
            <canvas id="${canvasId}" class="pdf-thumb-canvas"></canvas>
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-all flex items-center justify-center">
               <i class="fas fa-eye text-white opacity-0 group-hover:opacity-100 text-3xl"></i>
            </div>
          </div>
          <div class="p-3 bg-white border-t border-gray-50">
            <p class="text-[10px] font-bold ${isNew ? 'text-amber-600' : 'text-blue-600'} mb-1 uppercase">
              ${isNew ? 'Destaque do MÃªs' : 'Encarte Anterior'}
            </p>
            <p class="text-xs font-bold text-slate-700 leading-tight h-8 overflow-hidden line-clamp-2">${pdf.name.replace('.pdf','')}</p>
          </div>
        </div>`;
    }).join("");
  } catch (e) { 
    container.innerHTML = "<p class='col-span-full text-center text-red-500'>Erro ao carregar encartes.</p>"; 
  }
}
    function moveSlide(direction) {
      const slides = document.getElementById("carousel-slides");
      if (totalSlides === 0) return;
      currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
      slides.style.transform = `translateX(-${currentSlide * 100}%)`;
    }

    function switchTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".nav-link").forEach(el => el.classList.remove("active"));
      document.getElementById("tab-" + tabId).classList.add("active");
      if(event) event.currentTarget.classList.add("active");
      if (tabId === "home") loadHomeData();
      if (tabId === "treinamento") loadFiles("Manuais");
      if (tabId === "encartes") loadEncartes("Encartes");
    }

    async function loadFiles(path) {
      const container = document.getElementById("explorer-content");
      try {
        const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`);
        allFiles = await res.json();
        renderFileList(allFiles, path);
      } catch (e) { console.log(e); }
    }

    function renderFileList(files, currentPath) {
      const container = document.getElementById("explorer-content");
      let html = currentPath !== "Manuais" ? `<div class="p-4 text-blue-600 font-bold cursor-pointer border-b" onclick="loadFiles('Manuais')"><i class="fas fa-arrow-left mr-2"></i> Voltar</div>` : "";
      html += files.map(item => `
        <div class="flex items-center justify-between py-4 px-6 hover:bg-slate-50 cursor-pointer group" onclick="${item.type==='dir'?`loadFiles('${item.path}')`:`window.open('https://${USER}.github.io/${REPO}/${item.path}','_blank')`}">
          <div class="flex items-center gap-4">
            <i class="fas ${item.type==='dir'?'fa-folder text-yellow-500':'fa-file-pdf text-red-500'} text-2xl group-hover:scale-110 transition"></i>
            <span class="font-medium text-slate-700">${item.name}</span>
          </div>
          <i class="fas fa-chevron-right text-slate-200 group-hover:text-blue-500"></i>
        </div>`).join("");
      container.innerHTML = html;
    }

    window.onload = () => {
      loadHomeData();
      setInterval(() => moveSlide(1), 6000);
    };
  </script>
</body>
</html>
